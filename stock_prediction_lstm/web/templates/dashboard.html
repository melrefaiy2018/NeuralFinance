<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ticker_symbol }} Analysis - Stock AI Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .active-tab {
            border-color: #4f46e5 !important;
            color: #4f46e5 !important;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100 text-gray-800">

    <!-- Global Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
        <div class="flex items-center">
            <svg class="w-8 h-8 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L11 2m7 12v3m-3 3h6m-3-6v6"></path>
            </svg>
            <h1 class="text-2xl font-bold text-gray-900">Stock AI</h1>
        </div>
        <div class="text-sm">
            <span class="text-gray-600">Market Status:</span>
            <span class="font-medium {% if market_state == 'open' %}text-green-600{% else %}text-red-600{% endif %}">
                {{ market_state|title }}
            </span>
        </div>
        <a href="{{ url_for('index') }}" class="text-indigo-600 hover:text-indigo-800 font-medium">
            ← New Analysis
        </a>
    </header>

    <main class="flex flex-1 flex-col md:flex-row">
        <!-- Analysis Parameters Sidebar -->
        <aside class="w-full md:w-80 bg-white p-6 shadow-lg md:shadow-none md:border-r border-gray-200 flex-shrink-0">
            <h2 class="text-xl font-semibold mb-6 text-gray-900">Analysis Summary</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-700">Stock Analyzed</label>
                    <p class="text-lg font-bold text-indigo-600">{{ ticker_symbol }}</p>
                    {% if company_name %}
                    <p class="text-sm text-gray-600">{{ company_name }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label class="text-sm font-medium text-gray-700">Time Period</label>
                    <p class="text-gray-900">{{ period }}</p>
                </div>
                
                <div>
                    <label class="text-sm font-medium text-gray-700">Data Interval</label>
                    <p class="text-gray-900">{{ interval }}</p>
                </div>
                
                <div>
                    <label class="text-sm font-medium text-gray-700">Prediction Days</label>
                    <p class="text-gray-900">{{ prediction_days }} days</p>
                </div>
            </div>

            <div class="mt-8">
                <a href="{{ url_for('index') }}" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md text-center font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md block">
                    Run New Analysis
                </a>
            </div>

            {% if company_info %}
            <div class="mt-8">
                <div class="rounded-md bg-gray-50 p-4">
                    <button class="flex justify-between items-center w-full text-left text-gray-700 font-medium" onclick="toggleAccordion('company-info')">
                        Company Information
                        <svg class="w-5 h-5 transform transition-transform duration-200" id="company-info-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="company-info-content" class="mt-3 text-sm text-gray-600 hidden">
                        {% if company_info.longName %}
                        <p><strong>{{ company_info.longName }}</strong></p>
                        {% endif %}
                        {% if company_info.sector %}
                        <p>Sector: {{ company_info.sector }}</p>
                        {% endif %}
                        {% if company_info.industry %}
                        <p>Industry: {{ company_info.industry }}</p>
                        {% endif %}
                        {% if company_info.website %}
                        <p><a href="{{ company_info.website }}" target="_blank" class="text-indigo-500 hover:underline">Company Website</a></p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </aside>

        <!-- Main Content Area: Analysis Results -->
        <section class="flex-1 p-6 md:p-8 overflow-y-auto">
            <div class="space-y-8">
                <!-- Section A: The "Snapshot" Overview -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">{{ ticker_symbol }} Analysis Snapshot</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        
                        <!-- Current Price -->
                        {% if current_price %}
                        <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                            <p class="text-sm text-indigo-700 font-medium">Current Price</p>
                            <p class="text-3xl font-bold text-indigo-800 mt-1">
                                ${{ "%.2f"|format(current_price) }}
                                {% if price_change %}
                                <span class="{% if price_change >= 0 %}text-green-600{% else %}text-red-600{% endif %} text-xl font-semibold">
                                    {% if price_change >= 0 %}↑{% else %}↓{% endif %}{{ "%.2f"|format(price_change|abs) }}%
                                </span>
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}

                        <!-- Predicted Return -->
                        {% if predicted_return %}
                        <div class="p-4 {% if predicted_return >= 0 %}bg-green-50 border-green-200{% else %}bg-red-50 border-red-200{% endif %} rounded-lg border">
                            <p class="text-sm {% if predicted_return >= 0 %}text-green-700{% else %}text-red-700{% endif %} font-medium">Predicted {{ prediction_days }}-Day Return</p>
                            <p class="text-4xl font-bold {% if predicted_return >= 0 %}text-green-800{% else %}text-red-800{% endif %} mt-1">
                                {% if predicted_return >= 0 %}+{% endif %}{{ "%.2f"|format(predicted_return) }}%
                                <svg class="inline-block w-8 h-8 ml-2 {% if predicted_return >= 0 %}text-green-600{% else %}text-red-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    {% if predicted_return >= 0 %}
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                    {% else %}
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                                    {% endif %}
                                </svg>
                            </p>
                        </div>
                        {% endif %}

                        <!-- Analysis Conclusion -->
                        {% if analysis_conclusion %}
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-sm text-blue-700 font-medium">Analysis Conclusion</p>
                            <p class="text-xl font-bold text-blue-800 mt-1">
                                {{ analysis_conclusion }}
                                <span class="inline-block ml-2 text-gray-500 cursor-pointer" title="Based on technical indicators, sentiment analysis, and model predictions">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </span>
                            </p>
                        </div>
                        {% endif %}

                        <!-- Volatility Assessment -->
                        {% if volatility %}
                        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                            <p class="text-sm text-purple-700 font-medium">Volatility Assessment</p>
                            <p class="text-xl font-bold text-purple-800 mt-1">{{ volatility.level }} <span class="text-base font-normal">({{ "%.2f"|format(volatility.value) }}%)</span></p>
                        </div>
                        {% endif %}

                        <!-- Model Performance -->
                        {% if model_performance and model_performance.r2_score %}
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <p class="text-sm text-yellow-700 font-medium">Model R² Score</p>
                            <p class="text-xl font-bold text-yellow-800 mt-1">{{ "%.4f"|format(model_performance.r2_score) }} <span class="text-base font-normal">({% if model_performance.r2_score > 0.8 %}High{% elif model_performance.r2_score > 0.6 %}Medium{% else %}Low{% endif %} Confidence)</span></p>
                        </div>
                        {% endif %}

                        <!-- Sentiment Score -->
                        {% if sentiment_score %}
                        <div class="p-4 {% if sentiment_score >= 0.5 %}bg-green-50 border-green-200{% elif sentiment_score >= 0.3 %}bg-yellow-50 border-yellow-200{% else %}bg-red-50 border-red-200{% endif %} rounded-lg border">
                            <p class="text-sm {% if sentiment_score >= 0.5 %}text-green-700{% elif sentiment_score >= 0.3 %}text-yellow-700{% else %}text-red-700{% endif %} font-medium">Market Sentiment</p>
                            <p class="text-xl font-bold {% if sentiment_score >= 0.5 %}text-green-800{% elif sentiment_score >= 0.3 %}text-yellow-800{% else %}text-red-800{% endif %} mt-1">
                                {% if sentiment_score >= 0.7 %}Very Positive
                                {% elif sentiment_score >= 0.5 %}Positive
                                {% elif sentiment_score >= 0.3 %}Neutral
                                {% elif sentiment_score >= 0.1 %}Negative
                                {% else %}Very Negative{% endif %}
                                <span class="text-base font-normal">({{ "%.2f"|format(sentiment_score) }})</span>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Section B: Interactive Chart Gallery -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Price & Trend Visualizations</h2>
                    <div class="flex border-b border-gray-200 mb-4 overflow-x-auto">
                        {% if charts %}
                        {% for chart_name, chart_data in charts.items() %}
                        <button class="tab-button py-2 px-4 text-sm font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none whitespace-nowrap {% if loop.first %}active-tab{% endif %}" 
                                data-tab="{{ chart_name }}">
                            {{ chart_data.title or chart_name|title }}
                        </button>
                        {% endfor %}
                        {% endif %}
                    </div>

                    {% if charts %}
                    {% for chart_name, chart_data in charts.items() %}
                    <div id="{{ chart_name }}" class="tab-content {% if not loop.first %}hidden{% endif %}">
                        {% if chart_data.html %}
                        <div class="w-full">
                            {{ chart_data.html|safe }}
                        </div>
                        {% elif chart_data.url %}
                        <iframe src="{{ chart_data.url }}" class="w-full h-96 rounded-md border"></iframe>
                        {% else %}
                        <div class="w-full h-96 bg-gray-100 rounded-md flex items-center justify-center">
                            <p class="text-gray-500">Chart not available</p>
                        </div>
                        {% endif %}
                        {% if chart_data.description %}
                        <p class="text-sm text-gray-500 mt-2">{{ chart_data.description }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                <!-- Section C: Detailed Insights -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Detailed Insights</h2>

                    <!-- Daily Price Forecast Table -->
                    {% if future_predictions %}
                    <div class="mb-8">
                        <h3 class="text-xl font-medium text-gray-800 mb-3">Daily Price Forecast</h3>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Predicted Price</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Change</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for day, prediction in future_predictions.items() %}
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ loop.index }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ prediction.date }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${{ "%.2f"|format(prediction.price) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if prediction.change >= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                                            {% if prediction.change >= 0 %}+{% endif %}{{ "%.2f"|format(prediction.change) }}%
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Model Performance Metrics -->
                    {% if model_performance %}
                    <div class="mb-8">
                        <h3 class="text-xl font-medium text-gray-800 mb-3">Model Performance</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            {% if model_performance.rmse %}
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-700 font-medium">RMSE</p>
                                <p class="text-2xl font-bold text-gray-900 mt-1">{{ "%.4f"|format(model_performance.rmse) }}</p>
                                <p class="text-xs text-gray-500">Root Mean Squared Error (Lower is better)</p>
                            </div>
                            {% endif %}
                            {% if model_performance.mae %}
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-700 font-medium">MAE</p>
                                <p class="text-2xl font-bold text-gray-900 mt-1">{{ "%.4f"|format(model_performance.mae) }}</p>
                                <p class="text-xs text-gray-500">Mean Absolute Error (Lower is better)</p>
                            </div>
                            {% endif %}
                            {% if model_performance.r2_score %}
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-700 font-medium">R²</p>
                                <p class="text-2xl font-bold text-gray-900 mt-1">{{ "%.4f"|format(model_performance.r2_score) }}</p>
                                <p class="text-xs text-gray-500">R-squared (Higher is better)</p>
                            </div>
                            {% endif %}
                            {% if model_performance.mape %}
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-700 font-medium">MAPE</p>
                                <p class="text-2xl font-bold text-gray-900 mt-1">{{ "%.2f"|format(model_performance.mape) }}%</p>
                                <p class="text-xs text-gray-500">Mean Absolute % Error (Lower is better)</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Technical Indicators Summary -->
                    {% if technical_indicators %}
                    <div class="mb-8">
                        <h3 class="text-xl font-medium text-gray-800 mb-3">Technical Indicators Summary</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            {% for indicator, value in technical_indicators.items() %}
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-700 font-medium">{{ indicator|upper }}</p>
                                <p class="text-lg font-bold text-gray-900 mt-1">{{ value }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Understanding the Metrics -->
                    <div class="rounded-md bg-gray-50 p-4">
                        <button class="flex justify-between items-center w-full text-left text-gray-700 font-medium" onclick="toggleAccordion('understanding-metrics')">
                            Understanding the Metrics
                            <svg class="w-5 h-5 transform transition-transform duration-200" id="understanding-metrics-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="understanding-metrics-content" class="mt-3 text-sm text-gray-600 hidden">
                            <p><strong>RMSE (Root Mean Squared Error):</strong> Measures the average magnitude of the errors. Lower is better.</p>
                            <p><strong>MAE (Mean Absolute Error):</strong> Measures the average magnitude of the errors without considering their direction. Lower is better.</p>
                            <p><strong>R² (R-squared):</strong> Represents the proportion of the variance in the dependent variable that is predictable from the independent variables. Higher is better.</p>
                            <p><strong>MAPE (Mean Absolute Percentage Error):</strong> Expresses accuracy as a percentage of the error. Lower is better.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-300 text-xs p-4 text-center">
        <p>Disclaimer: These predictions are based on historical data and machine learning models, which have inherent limitations. Past performance is not indicative of future results. This information is for educational purposes only and should not be considered financial advice. Always consult with a qualified financial advisor before making investment decisions.</p>
        <p class="mt-2">&copy; 2025 Stock AI Assistant | Powered by Machine Learning and Sentiment Analysis | Data sourced from Yahoo Finance</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Tab functionality for charts
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and hide all content
                    tabButtons.forEach(btn => btn.classList.remove('active-tab', 'border-indigo-500', 'text-indigo-600'));
                    tabButtons.forEach(btn => btn.classList.add('border-transparent', 'text-gray-600'));
                    tabContents.forEach(content => content.classList.add('hidden'));

                    // Add active class to clicked button and show corresponding content
                    button.classList.add('active-tab', 'border-indigo-500', 'text-indigo-600');
                    button.classList.remove('border-transparent', 'text-gray-600');
                    document.getElementById(button.dataset.tab).classList.remove('hidden');
                });
            });
        });

        // Accordion toggle function
        function toggleAccordion(id) {
            const content = document.getElementById(id + '-content');
            const arrow = document.getElementById(id + '-arrow');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }
    </script>
</body>
</html>
